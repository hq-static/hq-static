### 3-2-3 系统功能流程串讲

#### 登录

- 输入网址http://localhost:8080/web/views/login/login.html
- 静态资源，直接访问resource/static/目录下的文件
- 浏览器显示resource/static/web/views/login/login.html
- 点击登录按钮

```
        hanlderSubmit: function () {
        	// 取页面上的用户名和密码
            var name = $(".user-name").val();
            var password = $(".pwd").val();
			// 输入参数判断
            if(name == "") {
            	// 全局公用函数，用来在页面上显示提示信息（提示信息在名为tips的div中）
                utils.showTip("用户名不能为空");
                return;
            }
            if(password == "") {
                utils.showTip("密码不能为空");
                return;
            }
 			// getLogin有三个参数，
 			// 第一个参数是url，
 			// 第二个参数是一个对象，用于代表用户在页面上的输入
 			// 第三个参数是一个函数，该函数在ajax请求得到成功返回之后，被调用
            utils.getLogin("/user/login", {
                "username": name,
                "password": password
            }, function (res) {
            	// res代表服务端响应请求后给回前端的返回，http的包体中的数据
                var token = res.token;
                var resourceList = JSON.stringify(res.resourceList);
                console.log(res);
                localStorage.setItem("token", token);
                localStorage.setItem("userName", res.name);
                localStorage.setItem("resourceList", resourceList);

                window.location.href = "../index/index.html";
            })
        },
```

- login.js中的handleSubmit
  - utils.getLogin()
  
  - ajax访问/user/login
    - 找到controller中对应方法（根据@RequestMapping，匹配到UserController.login方法）
    
    ```
        public AuthTokenDTO login(@RequestBody User u) {
            AuthTokenDTO authToken = null;
    		// 调用了服务的login方法
            User user = userService.login(u);
    
            if (user != null) {
    
    
                AuthTokenDetails authTokenDetails = new AuthTokenDetails();
                authTokenDetails.setId(user.getId());
                authTokenDetails.setUsername(user.getUsername());
                authTokenDetails.setExpirationDate(buildExpirationDate());
                authTokenDetails.setRoleNames(userService.getUserRoleNames(user.getId()));
    
                // Create auth token
                String jwt = tokenService.createJsonWebToken(authTokenDetails);
                if (jwt != null) {
                    authToken = new AuthTokenDTO();
                    authToken.setToken(jwt);
                    authToken.setUserId(user.getId());
                    authToken.setName(user.getName());
                    authToken.setResourceList(userService.resourceList(user.getId()));
                }
            } else {
                throw new RuntimeException("用户名或密码错误");
            }
    
            return authToken;
        }
    ```
    
    
    
    - 调用userService.login()接口
      - 根据@Service找到实现userService的类UserServiceImpl
    
        - @Service注解中的bean对象的名称
        - 在controller中声明了一个userService的属性
        - userService使用了@AutoWired注解
    
      - 调用UserServiceImpl.login
    
        ```
            public User login(User user) {
            	// 构造参数
                Map<String, Object> params = new HashMap<>();
                params.put("username", user.getUsername());
                params.put("password", DigestUtils.md5Hex(user.getPassword()));
                // 调用了mapper接口的login方法
                user = userMapper.login(params);
                return user;
            }
        ```
    
      - 调用userMapper.login，在数据库中查找
    
        - UserMapper接口由mybatis动态实现
        - 生成类的配置信息在resources/mapper/xxxMapper.xml文件（该文件的名字要和Mapper接口的名字一致）中
        - mapper.xml文件中的namespace必须填写对应Mapper接口的包路径
        - mapper.xml文件中，id的名字必须和Mapper接口中的方法名相同。每个方法对应于一个sql语句
    
      - 实际执行的resource/UserMapper.xml中的login方法（<select id="login" ...>）
        - mybatis组装输入参数
        - 执行查询
        - mybatis组装结果，结果会组装成User对象（resultType）
    
      - 生成jwt令牌（token）
    
        - 生成了一个tokenDTO对象，其中包含有token，userid，name
        - 将tokenDTO对象抓换成JSON字符串，返回到前端
      
    - 返回dto，spring框架将之转换为json
    
  - 回调index.js中的响应函数
  
  - 本地保存用户信息，以待后用
  
  ```
                  localStorage.setItem("token", token);
                  localStorage.setItem("userName", res.name);
                  localStorage.setItem("resourceList", resourceList);
  ```
  
  - 页面跳转（URL不建议使用相对路径）
  
  ```
  window.location.href = "../index/index.html";
  ```
  
  展示“../index/index.html”
  

#### 代码即配置

- http资源与处理函数的对应（@RequestMapping）
- http上传参数与解析（json对象）
  - 上传的参数名，必须和model对象的属性名相同

- @AutoWired如何生效
  - @AutoWired <===>@Service：service类的变量名，和@Service注解中的名称必须一致
  - @AutoWired <===>@Mapper：Mapper类变量名，必须和类型名一致（首字母小写）
- Mapper接口与Mapper.xml
  - 类名与文件名
  - 包路径与命名空间
  - 方法（方法名、入参、返回值）

#### 资源处理

- 访问资源../index/index.html（web/views/index/index.html）

- 访问静态资源(static/web/.....)

- 显示index.html页面
  - 显示页面框架（即index.html内容）
  
  - 加载菜单（index.js --> initialize）
    - 访问/resource/menus
    
    ```
            var _this = this;
            $.ajax({
                url: baseUrl + url,
                type: 'POST',
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                // 发送http包之前调用的
                beforeSend: function (request) {
                	// 在http包头中增加一个Authorization的字段
                	// token作为全局变量，在localstorage获取，有token意味着曾经成功登录系统
                    request.setRequestHeader("Authorization", token);
                },
                data: JSON.stringify(param ? param : {}),
                success: function (res) {
                	// this和_this指向的对象是不同的
                	// getData函数作用是统一判断http调用是否出错，如果出错则统一提示错误信息，如果成功（http状态码200，则调用callback函数）
                    _this.getData(res, callback);
                },
                fail: function () {
                }
            });
    ```
    
    - 调用ResourceController.menus()（从@RequestMapping中查找/resource/menus）
      - 调用resourceService.menus()（实际为ResourceServiceImpl）
        
        ```
                List<Menu> menuList = new ArrayList<>();
        
        		// 设置查询条件中的type和userID
        		// 只查用户自己有权限使用的菜单项
                Map<String, Object> params = new HashMap<>();
                params.put("type", AppConst.RESOURCE_TYPE_MENU);// 菜单类型的资源
                Long currUid = SessionUtil.getCurrUid();
                params.put("userId", currUid);// 只查自己有权限的资源
        
                List<Resource> resourceList = resourceMapper.getResourceList(params);
        
                assembleMenu(menuList, resourceList);
                return menuList;
        ```
        
        - 调用resourceMapper.getResourceList()
        
        - 执行ResourceMapper.xml中的getResourceList的sql语句
        
          ```
                  SELECT r.*
                  FROM dmc.resource r
                  <!--where标签用于自动给后续的查询条件去掉多余的and -->
                  <where>
                  	<!--判断test中的表达式是否为真，为真则标签内的内容生效，否则不生效 -->
                      <if test="userId != null">
                          and exists(select 1 from dmc.role_resource rr INNER JOIN dmc.role role ON rr.ROLE_ID = role.ID
                          INNER JOIN dmc.user_role ur ON ur.ROLE_ID = role.ID INNER JOIN user u ON u.ID = ur.USER_ID
                          WHERE u.ID = #{userId} AND rr.RESOURCE_ID = r.ID)
                      </if>
                      <if test="roleId != null">
                          and exists(select 1 from dmc.role_resource rr INNER JOIN role role ON rr.ROLE_ID = role.ID
                          WHERE rr.RESOURCE_ID = r.ID and role.id = #{roleId})
                      </if>
                      <if test="type != null">
                          and r.type = #{type}
                      </if>
                  </where>
          
                  order by r.seq
          ```
        
          - if test的用处
          - 分析SQL语句：
        
          ```
                  SELECT r.*
                  FROM dmc.resource r
                  where
                  <!--查询该用户有权限访问的所有resource -->
                         exists(select 1 from dmc.role_resource rr INNER JOIN dmc.role role ON rr.ROLE_ID = role.ID
                          INNER JOIN dmc.user_role ur ON ur.ROLE_ID = role.ID INNER JOIN user u ON u.ID = ur.USER_ID
                          WHERE u.ID = #{userId} AND rr.RESOURCE_ID = r.ID)
                          and r.type = #{type}
                  order by r.seq
          ```
        
          - exists关键字的执行顺序（外部查询--条件筛选） 
          - 参数（Map）的用法
          - result的组装
            - 实体类的组装：字段名和属性名相同
            - List的组装
        
        - 组装menuList（形成父子关系）
        
        ```
                for (Resource r : resourceList) {
                    if (r.getPid() == null) {
                    	// 当前的resource属于顶级目录  
                        Menu menu = new Menu();
                        // 将r中的属性赋值给menu中的同名属性
                        BeanUtils.copyProperties(r, menu);
                        // name属性单独复制
                        menu.setText(r.getName());
                        List<Menu> children = new ArrayList<>();
                        for (Resource r1 : resourceList) {
                            if (Objects.equals(r1.getPid(), r.getId())) {
                            // r1是r的子资源
                                Menu child = new Menu();
                                BeanUtils.copyProperties(r1, child);
                                child.setText(r1.getName());
                                children.add(child);
                            }
                        }
                        menu.setChildren(children);
                        menuList.add(menu);
                    }
                }
        ```
        
        
      
    - 返回页面menuList（Json形式）
    
    - 画menu（menu的html代码在“menuTemplate”）
      
      ```
      $(".menu-ul").empty().append(this.menuTemplate(this.model.toJSON()));
      ```
      
      - menuTemplates
      
        ```
        <script type="text/template" id="menuTemplate">
        	<!-- <% %>括起来的内容，都是jsp代码（el表达式），其内容不会输出到html页面中，只是用来控制代码流程 -->
            <%for(var i = 0; i < list.length; i ++){%>
            <li>
                <a>
                    <img src="../../images/cai.png" class="cai-img">
                    <%=list[i].text%>
                    <img src="../../images/arrow.png" class="arrow">
                </a>
                <ul class="item-ul">
                    <%for(var j = 0; j < list[i].children.length; j ++){%>
                    <li class="iframe<%=list[i].children[j].id%>" data-text="<%=list[i].children[j].text%>"
                        data-link="<%=list[i].children[j].url%>" data-id="<%=list[i].children[j].id%>"><span
                            class="li-icon">-</span><%=list[i].children[j].text%>
                    </li>
                    <%}%>
                </ul>
            </li>
            <%}%>
        </script>
        ```
      
      - 双重循环
      
      - list为model中的menuList
    
  - 设置主窗体的显示资源（../home/home.html）
  
- 点击“资源管理页面”（../menu/menu.html）

- 访问静态资源

- 显示menu.html页面（在主窗体）

- 加载页面动态内容（menu.js --> initialize）
  - 访问/resource/treeList
  
  - 调用ResourceController.treeList()
    - 调用resourceService.treeList()（实际为ResourceServiceImpl）
      
      ```
              // 组装执行sql所需的参数
              Map<String, Object> params = new HashMap<>();
              Long currUid = SessionUtil.getCurrUid();
      
              if (currUid != null) {
                  params.put("userId", currUid);// 自查自己有权限的资源
              }
      
      		// 执行sql，取出了用户能够操作的所有页面和功能
              List<Resource> resourceList = resourceMapper.getResourceList(params);
      		// 组装结果（前端需要的参数形式），menu的三级结构（一级页面--二级页面--页面功能）
      		// 在map中准备resource，所有的resouce以id为key，resource中的pname已经被正确设置
              Map<Long, Resource> map = new HashMap<>();
              resourceList.forEach(resource -> map.put(resource.getId(), resource));
              /* forEach相当于这段代码
              for(Resource r : resourceList) {
              	map.put(r.getId(),r);
              }
              */
              resourceList.forEach(resource -> resource.setPname(resource.getPid() != null ? map.get(resource.getPid()).getName() : null));
              /* 等效代码
              for(Resouce r : resouceList) {
              	if (r.getPid != null) {
              		r.setPname(map.get(r.getPid()).getName())
              	} else {
              		r.setPname(null)
              	}
              }
              */
      
              List<Resource> list = new ArrayList<>();
      
              resourceList = new CopyOnWriteArrayList<>(resourceList);
              for (Resource resource : resourceList) {
                  if (resource.getPid() == null) {
                      list.add(resource);
                      resourceList.remove(resource);
                      treeSort(resourceList, list, resource);
                  }
              }
      
              return list;
      ```
      
      
      
      - 调用resourceMapper.treeList()
      
      - 执行ResourceMapper中的getResourceList语句
        - 同上
        
      - 设置resource的pname（数据库中没有）
      
      - 递归函数给资源树排序（treeSort）
        - treeSort(resourceList, list, resource)：在resourceList中，将resource的子节点（包括子节点的子节点按顺序）添加到list中
        
          ```
              private void treeSort(List<Resource> resourceList, List<Resource> list, Resource parent) {
          
                  for (Resource resource : resourceList) {
                      if (Objects.equals(parent.getId(), resource.getPid())) {
                          list.add(resource);
                          resourceList.remove(resource);
                          // 如果当前节点有子节点，则将子节点插入到本节点的子节点中
                          treeSort(resourceList, list, resource);
                      }
                  }
              }
          ```
        
          
      
    - 返回list	
    
    - render（填写动态内容）
      - 填写tree表格（JQuery的treetable组件）
      
      ```
      <script type="text/template" id="treeTemplate">
          <thead>
          <tr>
              <th>资源名称</th>
              <th>URL</th>
              <th>METHOD</th>
              <th>类型</th>
              <th>排序</th>
              <th>操作</th>
          </tr>
          </thead>
          <tbody class="tree-body">
          <%for(var i = 0; i < list.length; i ++){%>
          <tr data-tt-id="<%=list[i].id%>"
          <%if(typeof list[i].pid != "undefined"){%>data-tt-parent-id="<%=list[i].pid%>"<%}%>>
          <td><%=list[i].name%></td>
          <td><%=list[i].url%></td>
          <td><%=list[i].method%></td>
          <td><%=list[i].type=="1"?"功能":"菜单"%></td>
          <td><%=list[i].sort%></td>
          <td>
          <!--需不需要显示修改和删除按钮 --> 
              <%if($.inArray("/resource-put",resourceData) > -1){%><a data-id="<%=list[i].id%>"
                                                                      class="edit-btn btn btn-xs btn-primary pointer"><i
                  class='fa fa-pencil' aria-hidden='true'></i> 编辑</a><%}%>
              <%if($.inArray("/resource/*-delete",resourceData) > -1){%><a data-id="<%=list[i].id%>"
                                                                           class="del-btn btn btn-xs btn-danger pointer"><i
                  class='fa fa-trash-o' aria-hidden='true'></i> 删除</a><%}%>
          </td>
          </tr>
          <%}%>
          </tbody>
      </script>
      ```
      
      - 填写toolbox			